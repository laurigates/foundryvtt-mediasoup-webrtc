name: Integration Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  # Run Rust server tests first
  server-tests:
    name: MediaSoup Server Tests
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      
    - name: Cache Rust dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          server/target
        key: ${{ runner.os }}-cargo-${{ hashFiles('server/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-
    
    - name: Run server tests
      run: |
        cd server
        cargo test --verbose
        
    - name: Build server for integration tests
      run: |
        cd server  
        cargo build --release

  # Browser-based integration tests
  integration-tests:
    name: Browser Integration Tests
    runs-on: ubuntu-latest
    needs: server-tests
    
    strategy:
      matrix:
        browser: [chromium, firefox]
        
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
      
    - name: Build plugin
      run: npm run build
      
    - name: Build test plugin
      run: npm run build:test
      
    - name: Get Playwright version for caching
      id: playwright-version
      run: echo "version=$(npx playwright --version | cut -d' ' -f2)" >> $GITHUB_OUTPUT
      
    - name: Cache Playwright browsers
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/ms-playwright
          ~/Library/Caches/ms-playwright
          %USERPROFILE%\AppData\Local\ms-playwright
        key: ${{ runner.os }}-playwright-${{ steps.playwright-version.outputs.version }}-${{ matrix.browser }}-v2
        restore-keys: |
          ${{ runner.os }}-playwright-${{ steps.playwright-version.outputs.version }}-
          ${{ runner.os }}-playwright-
          
    - name: Install Playwright browsers with retry
      run: |
        echo "Installing Playwright browser: ${{ matrix.browser }}"
        
        # Retry installation with backoff
        for attempt in 1 2 3; do
          echo "Attempt $attempt: Installing ${{ matrix.browser }}..."
          
          if [ $attempt -gt 1 ]; then
            echo "Clearing cache before retry..."
            rm -rf ~/.cache/ms-playwright/${{ matrix.browser }}* || true
            rm -rf ~/Library/Caches/ms-playwright/${{ matrix.browser }}* || true
            rm -rf "$USERPROFILE/AppData/Local/ms-playwright/${{ matrix.browser }}*" || true
            sleep $((attempt * 15))
          fi
          
          if npx playwright install --with-deps ${{ matrix.browser }}; then
            echo "âœ… Browser ${{ matrix.browser }} installed successfully"
            break
          else
            echo "âŒ Browser ${{ matrix.browser }} installation failed on attempt $attempt"
            if [ $attempt -eq 3 ]; then
              echo "All attempts failed. Exiting."
              exit 1
            fi
          fi
        done
        
    - name: Verify browser installation
      run: |
        echo "ðŸ” Verifying ${{ matrix.browser }} installation..."
        node -e "
          (async () => {
            try {
              const { ${{ matrix.browser }} } = require('@playwright/test');
              const browser = await ${{ matrix.browser }}.launch({ 
                headless: true, 
                timeout: 30000,
                args: process.platform === 'linux' ? ['--no-sandbox', '--disable-setuid-sandbox'] : []
              });
              console.log('âœ… ${{ matrix.browser }} browser verification successful');
              await browser.close();
            } catch (error) {
              console.error('âŒ ${{ matrix.browser }} browser verification failed:', error.message);
              process.exit(1);
            }
          })();
        "
      
    - name: Start MediaSoup server
      run: |
        # Start MediaSoup server if available
        if [ -f server/target/release/mediasoup-server ]; then
          cd server
          RUST_LOG=warn ./target/release/mediasoup-server &
          echo $! > ../mediasoup_server.pid
          cd ..
          
          # Wait for MediaSoup server
          timeout 30 bash -c 'until nc -z localhost 4443; do sleep 1; done' || true
        fi
      
    - name: Wait for system stability
      run: |
        echo "â±ï¸  Waiting for system stability before running tests..."
        sleep 10
        
        # Verify no competing processes
        echo "ðŸ” Checking for existing browser processes..."
        pkill -f "chrome|chromium|firefox" || true
        sleep 5
        
    - name: Run integration tests
      run: npx playwright test --project=${{ matrix.browser }}-webrtc
      env:
        CI: true
        WEBRTC_DEBUG: false
        PLAYWRIGHT_BROWSERS_PATH: ""  # Use default path
        # Add debugging for browser launch issues
        DEBUG: "pw:browser*"
      timeout-minutes: 15
        
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-results-${{ matrix.browser }}
        path: |
          tests/results/
          test-results/
        retention-days: 30
        
    - name: Stop MediaSoup server
      if: always()
      run: |
        # Stop MediaSoup server
        if [ -f mediasoup_server.pid ]; then
          kill $(cat mediasoup_server.pid) || true
          rm mediasoup_server.pid
        fi

  # Docker-based full integration tests
  docker-integration:
    name: Docker Integration Tests
    runs-on: ubuntu-latest
    needs: server-tests
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Build and test with Docker Compose
      run: |
        docker compose -f docker-compose.test.yml build
        docker compose -f docker-compose.test.yml up --abort-on-container-exit --exit-code-from playwright-tests
      env:
        CI: true
        
    - name: Collect test artifacts from container
      if: always()
      run: |
        # Create results directory
        mkdir -p test-results-docker
        
        # Copy results from container if it exists
        docker compose -f docker-compose.test.yml ps -q playwright-tests | xargs -I {} docker cp {}:/app/tests/results ./test-results-docker/ || true
        
    - name: Upload Docker test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: docker-integration-results
        path: test-results-docker/
        retention-days: 30
        
    - name: Cleanup
      if: always()
      run: docker compose -f docker-compose.test.yml down -v

  # Smoke tests for different environments
  smoke-tests:
    name: Smoke Tests
    runs-on: ${{ matrix.os }}
    
    strategy:
      fail-fast: false  # Allow other OS tests to continue if one fails
      matrix:
        os: [ubuntu-22.04, macos-latest, windows-latest]
        node-version: [20, 22]
        exclude:
          # Reduce matrix complexity - only test Node 22 on Ubuntu
          - os: macos-latest
            node-version: 22
          - os: windows-latest  
            node-version: 22
        
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
      
    - name: Lint code
      run: npm run lint
      
    - name: Build plugin
      run: npm run build
      
    - name: Build test plugin
      run: npm run build:test
      
    - name: Verify build output
      run: |
        test -f dist/mediasoup-vtt.js
        test -f dist/module.json
        test -f dist/mediasoup-vtt-test.js
        
    - name: Get Playwright version for caching
      id: playwright-version
      run: echo "version=$(npx playwright --version | cut -d' ' -f2)" >> $GITHUB_OUTPUT
      
    - name: Cache Playwright browsers
      id: playwright-cache
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/ms-playwright
          ~/Library/Caches/ms-playwright
          %USERPROFILE%\AppData\Local\ms-playwright
        key: ${{ runner.os }}-playwright-${{ steps.playwright-version.outputs.version }}-chromium-v2
        restore-keys: |
          ${{ runner.os }}-playwright-${{ steps.playwright-version.outputs.version }}-
          ${{ runner.os }}-playwright-
          
    - name: Install Playwright browsers with retry and verification
      shell: bash
      run: |
        echo "Installing Playwright browsers with enhanced error handling..."
        
        # Function to install with retry
        install_with_retry() {
          local max_attempts=3
          local attempt=1
          local delay=30
          
          while [ $attempt -le $max_attempts ]; do
            echo "Attempt $attempt/$max_attempts: Installing Playwright browsers..."
            
            # Clear potentially corrupted cache on retry
            if [ $attempt -gt 1 ]; then
              echo "Clearing Playwright cache before retry..."
              npx playwright install --help > /dev/null 2>&1 || true
              rm -rf ~/.cache/ms-playwright/chromium* || true
              rm -rf ~/Library/Caches/ms-playwright/chromium* || true
              rm -rf "$USERPROFILE/AppData/Local/ms-playwright/chromium*" || true
            fi
            
            if npx playwright install --with-deps chromium; then
              echo "âœ… Browser installation successful on attempt $attempt"
              return 0
            else
              echo "âŒ Browser installation failed on attempt $attempt"
              if [ $attempt -lt $max_attempts ]; then
                echo "Waiting ${delay}s before retry..."
                sleep $delay
                delay=$((delay * 2))  # Exponential backoff
              fi
            fi
            attempt=$((attempt + 1))
          done
          
          echo "âŒ All browser installation attempts failed"
          return 1
        }
        
        # Perform installation with retry
        if ! install_with_retry; then
          echo "ðŸ“Š Standard installation failed. Trying platform-specific fallbacks..."
          
          # Platform-specific fallback methods
          case "${{ runner.os }}" in
            "Windows")
              echo "ðŸªŸ Attempting Windows-specific fallback..."
              # Clear all caches
              if [ -d "$USERPROFILE/AppData/Local/ms-playwright" ]; then
                rm -rf "$USERPROFILE/AppData/Local/ms-playwright" || true
              fi
              # Force fresh installation without cache
              npx playwright@latest install chromium --force || (
                echo "âŒ Windows fallback also failed"
                echo "ðŸ“Š System info:"
                echo "Disk space:"
                df -h 2>/dev/null || du -sh "$USERPROFILE" || echo "Could not get disk info"
                echo "Memory info:"
                free -h 2>/dev/null || echo "Could not get memory info"
                exit 1
              )
              ;;
            "macOS")
              echo "ðŸŽ Attempting macOS-specific fallback..."
              # Clear cache and try with system Chrome if available
              rm -rf ~/Library/Caches/ms-playwright || true
              if [ -f "/Applications/Google Chrome.app/Contents/MacOS/Google Chrome" ]; then
                echo "Found system Chrome, using as fallback"
                export PLAYWRIGHT_BROWSERS_PATH="/Applications/Google Chrome.app/Contents/MacOS/"
              fi
              npx playwright@latest install chromium --force || (
                echo "âŒ macOS fallback also failed"
                echo "ðŸ“Š System info:"
                system_profiler SPSoftwareDataType
                vm_stat
                df -h
                exit 1
              )
              ;;
            "Linux")
              echo "ðŸ§ Attempting Linux-specific fallback..."
              # Try installing system dependencies manually
              sudo apt-get update -y || true
              sudo apt-get install -y libnss3 libatk-bridge2.0-0 libdrm2 libxkbcommon0 libxcomposite1 libxdamage1 libxrandr2 libgbm1 libxss1 libasound2 || true
              npx playwright@latest install chromium --force || (
                echo "âŒ Linux fallback also failed"
                echo "ðŸ“Š System info:"
                uname -a
                free -h
                df -h
                exit 1
              )
              ;;
            *)
              echo "âŒ Unknown platform: ${{ runner.os }}"
              echo "ðŸ“Š Gathering system information for debugging..."
              echo "OS: ${{ runner.os }}"
              echo "Platform: $(uname -a 2>/dev/null || echo 'Unknown')"
              echo "Node version: $(node --version)"
              echo "NPM version: $(npm --version)"
              echo "Available space:"
              df -h 2>/dev/null || dir || Get-WmiObject -Class Win32_LogicalDisk | Format-Table -AutoSize
              echo "Memory:"
              free -h 2>/dev/null || vm_stat || systeminfo | findstr Memory
              exit 1
              ;;
          esac
        fi
        
        echo "ðŸ” Verifying browser installation..."
        npx playwright install-deps chromium || echo "âš ï¸  Warning: install-deps failed, but continuing..."
      
    - name: Verify browser executable paths
      run: |
        echo "ðŸ” Verifying browser executables are accessible..."
        
        # Get Playwright browser paths
        if command -v npx >/dev/null 2>&1; then
          echo "ðŸ“ Checking Playwright browser locations..."
          
          # Try to get browser path using Playwright's internal method
          node -e "
            try {
              const { chromium } = require('@playwright/test');
              console.log('Chromium executable should be available');
              
              // Test browser launch
              (async () => {
                try {
                  const browser = await chromium.launch({ 
                    headless: true,
                    timeout: 30000,
                    args: ['--no-sandbox', '--disable-setuid-sandbox']
                  });
                  console.log('âœ… Browser launch test successful');
                  await browser.close();
                } catch (error) {
                  console.error('âŒ Browser launch test failed:', error.message);
                  // List available browsers in cache
                  const fs = require('fs');
                  const os = require('os');
                  const path = require('path');
                  
                  const cacheDir = process.platform === 'win32' 
                    ? path.join(os.homedir(), 'AppData', 'Local', 'ms-playwright')
                    : process.platform === 'darwin'
                    ? path.join(os.homedir(), 'Library', 'Caches', 'ms-playwright')  
                    : path.join(os.homedir(), '.cache', 'ms-playwright');
                  
                  if (fs.existsSync(cacheDir)) {
                    console.log('ðŸ“‚ Contents of Playwright cache directory:');
                    fs.readdirSync(cacheDir).forEach(item => {
                      const itemPath = path.join(cacheDir, item);
                      const stats = fs.statSync(itemPath);
                      console.log('  ' + (stats.isDirectory() ? 'ðŸ“' : 'ðŸ“„') + ' ' + item);
                    });
                  } else {
                    console.log('âŒ Playwright cache directory does not exist:', cacheDir);
                  }
                  process.exit(1);
                }
              })();
            } catch (error) {
              console.error('âŒ Failed to verify browser:', error.message);
              process.exit(1);
            }
          " || exit 1
        else
          echo "âŒ npx command not available"
          exit 1
        fi
      
    - name: Configure OS-specific settings
      if: runner.os == 'Windows'
      run: |
        # Windows-specific: Add Windows Defender exclusion for better performance
        powershell -Command "Add-MpPreference -ExclusionPath '${{ github.workspace }}' -Force" || true
      shell: bash
      
    - name: Wait for browser readiness
      run: |
        echo "â±ï¸  Ensuring browser is ready for smoke tests..."
        sleep 5
        
        # Kill any stray browser processes
        pkill -f "chrome|chromium|firefox" || true
        sleep 2
        
    - name: Run smoke tests
      run: npx playwright test tests/integration/specs/plugin-loading.spec.js --project=chromium-webrtc
      env:
        CI: true
        NODE_OPTIONS: --max-old-space-size=4096
        PLAYWRIGHT_BROWSERS_PATH: ""  # Use default path
        DEBUG: "pw:browser*"
      timeout-minutes: 10
        
    - name: Upload smoke test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: smoke-test-results-${{ matrix.os }}-node${{ matrix.node-version }}
        path: |
          tests/results/
          test-results/
          screenshots/
        retention-days: 30
        
    - name: Log system information on failure
      if: failure()
      run: |
        echo "=== System Information ==="
        echo "OS: ${{ matrix.os }}"
        echo "Node: ${{ matrix.node-version }}"
        echo "Runner: ${{ runner.os }}"
        echo "Platform: $(uname -a)"
        echo "Memory: $(free -h 2>/dev/null || vm_stat || systeminfo | findstr Memory)"
        echo "Disk: $(df -h 2>/dev/null || dir || Get-WmiObject -Class Win32_LogicalDisk)"
        echo "Processes: $(ps aux | head -20 2>/dev/null || tasklist | head -20)"
        echo "=== Browser Processes ==="
        ps aux | grep -E "(chrome|chromium|firefox)" | head -10 || true
        echo "=== Test Artifacts ==="
        find tests/results test-results -type f -name "*.log" -o -name "*.json" -o -name "*.xml" 2>/dev/null | head -10 || true
      shell: bash

  # Security and dependency checks
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
      
    - name: Run npm audit
      run: npm audit --audit-level=moderate
      
    - name: Install Rust for server audit
      if: hashFiles('server/Cargo.toml') != ''
      uses: dtolnay/rust-toolchain@stable
      
    - name: Audit Rust dependencies
      if: hashFiles('server/Cargo.toml') != ''
      run: |
        cd server
        # Install cargo-audit if not already installed
        cargo install cargo-audit --locked || true
        # Run audit but allow some known transitive dependency warnings
        # mediasoup v0.20.0 has transitive dependencies with warnings that are not directly exploitable
        cargo audit || {
          exit_code=$?
          # Exit code 1 means vulnerabilities found, show them but continue
          # since these are in transitive dependencies we cannot directly fix
          if [ $exit_code -eq 1 ]; then
            echo "âš ï¸ Warning: Vulnerabilities found in transitive dependencies"
            echo "These are known issues in mediasoup v0.20.0's dependency chain"
            echo "Direct exploitation is unlikely in our usage context"
            exit 0
          else
            # Any other exit code is a real error
            exit $exit_code
          fi
        }

  # Generate and publish test report
  test-report:
    name: Test Report
    runs-on: ubuntu-latest
    needs: [integration-tests, docker-integration, smoke-tests]
    if: always()
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      
    - name: Generate test report
      run: |
        echo "# MediaSoup Integration Test Report" > test-report.md
        echo "" >> test-report.md
        echo "## Test Results Summary" >> test-report.md
        echo "" >> test-report.md
        
        # Count test files and results
        if [ -d playwright-results-chromium ]; then
          echo "- âœ… Chromium tests completed" >> test-report.md
        else
          echo "- âŒ Chromium tests failed" >> test-report.md
        fi
        
        if [ -d playwright-results-firefox ]; then
          echo "- âœ… Firefox tests completed" >> test-report.md
        else
          echo "- âŒ Firefox tests failed" >> test-report.md
        fi
        
        if [ -d docker-integration-results ]; then
          echo "- âœ… Docker integration tests completed" >> test-report.md
        else
          echo "- âŒ Docker integration tests failed" >> test-report.md
        fi
        
        echo "" >> test-report.md
        echo "## Test Coverage" >> test-report.md
        echo "- Plugin loading and initialization" >> test-report.md
        echo "- Settings configuration and management" >> test-report.md
        echo "- WebSocket server connection" >> test-report.md
        echo "- WebRTC media capture and streaming" >> test-report.md
        echo "- Browser compatibility (Chromium, Firefox)" >> test-report.md
        
    - name: Upload test report
      uses: actions/upload-artifact@v4
      with:
        name: test-report
        path: test-report.md
        retention-days: 90